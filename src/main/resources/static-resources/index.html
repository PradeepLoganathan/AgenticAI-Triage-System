<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akka AI Agent Triage Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 0;
            min-height: 800px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-right: 1px solid #e9ecef;
        }

        .workflow-section {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        textarea, select, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        textarea:focus, select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .demo-scenarios {
            background: #e8f4ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .demo-scenarios h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .scenario-btn {
            display: block;
            width: 100%;
            margin-bottom: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            text-align: left;
            font-size: 13px;
            transition: all 0.3s;
        }

        .scenario-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
            width: 100%;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .workflow-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
            padding: 15px 10px;
        }

        .step:not(:last-child)::after {
            content: 'â†’';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: #ccc;
        }

        .step.active {
            background: #667eea;
            color: white;
            border-radius: 8px;
        }

        .step.completed {
            background: #28a745;
            color: white;
            border-radius: 8px;
        }

        .step.active::after,
        .step.completed::after {
            color: white;
        }

        .step-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .step-desc {
            font-size: 12px;
            opacity: 0.8;
        }

        .agent-cards {
            display: grid;
            gap: 20px;
        }

        .agent-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .agent-card.active {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .agent-card.completed {
            border-color: #28a745;
        }

        .agent-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .agent-card.active .agent-header {
            background: #667eea;
            color: white;
        }

        .agent-card.completed .agent-header {
            background: #28a745;
            color: white;
        }

        .agent-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .agent-status {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .agent-content {
            padding: 20px;
        }

        .input-output {
            margin-bottom: 20px;
        }

        .input-output h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #667eea;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #dc3545;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #667eea;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 5px;
        }

        .timestamp {
            font-size: 0.8rem;
            color: #6c757d;
            float: right;
        }

        .conversation-timeline {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .conversation-timeline h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .timeline-entry {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 15px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #e9ecef;
        }

        .timeline-entry.system {
            border-left-color: #6c757d;
        }

        .timeline-entry.user {
            border-left-color: #007bff;
        }

        .timeline-entry.assistant {
            border-left-color: #28a745;
        }

        .timeline-icon {
            font-size: 1.2rem;
            margin-top: 2px;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-role {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .timeline-message {
            font-size: 0.9rem;
            line-height: 1.4;
            color: #495057;
        }

        .timeline-time {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 8px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .input-section {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Akka AI Agent Triage System</h1>
            <p>Intelligent Multi-Agent Incident Response Workflow</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <div class="demo-scenarios">
                    <h3>Demo Scenarios</h3>
                    <button class="scenario-btn" onclick="loadScenario('payment-outage')">
                        Payment Service Outage (P1)
                    </button>
                    <button class="scenario-btn" onclick="loadScenario('database-slow')">
                        Database Performance Degradation (P2)
                    </button>
                    <button class="scenario-btn" onclick="loadScenario('auth-errors')">
                        Authentication Service Errors (P2)
                    </button>
                    <button class="scenario-btn" onclick="loadScenario('deployment-issue')">
                        Post-Deployment Issues (P3)
                    </button>
                </div>

                <form id="triageForm">
                    <div class="form-group">
                        <label for="triageId">Triage ID:</label>
                        <input type="text" id="triageId" value="" placeholder="auto-generated">
                    </div>

                    <div class="form-group">
                        <label for="incident">Incident Description:</label>
                        <textarea id="incident" placeholder="Describe the incident in detail..." required></textarea>
                    </div>

                    <button type="submit" class="btn-primary" id="startBtn">
                        Start Triage Workflow
                    </button>
                </form>

                <div class="metrics" id="metricsPanel" style="display: none;">
                    <div class="metric-card">
                        <div class="metric-value" id="totalTime">0s</div>
                        <div class="metric-label">Total Time</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="completedSteps">0/7</div>
                        <div class="metric-label">Completed Steps</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="currentSeverity">-</div>
                        <div class="metric-label">Severity</div>
                    </div>
                </div>
            </div>

            <div class="workflow-section">
                <div class="workflow-progress" id="workflowProgress">
                    <div class="step" data-step="classify">
                        <div class="step-title">Classify</div>
                        <div class="step-desc">Analyze & categorize incident</div>
                    </div>
                    <div class="step" data-step="evidence">
                        <div class="step-title">Evidence</div>
                        <div class="step-desc">Gather logs & metrics</div>
                    </div>
                    <div class="step" data-step="triage">
                        <div class="step-title">Triage</div>
                        <div class="step-desc">Root cause analysis</div>
                    </div>
                    <div class="step" data-step="knowledge">
                        <div class="step-title">Knowledge</div>
                        <div class="step-desc">Search runbooks & docs</div>
                    </div>
                    <div class="step" data-step="remediate">
                        <div class="step-title">Remediate</div>
                        <div class="step-desc">Plan solutions</div>
                    </div>
                    <div class="step" data-step="summarize">
                        <div class="step-title">Summarize</div>
                        <div class="step-desc">Create communications</div>
                    </div>
                    <div class="step" data-step="complete">
                        <div class="step-title">Complete</div>
                        <div class="step-desc">Workflow finished</div>
                    </div>
                </div>

                <div class="conversation-timeline" id="conversationTimeline" style="display: none;">
                    <h3>ðŸ“‹ Conversation Timeline</h3>
                    <div class="timeline-content" id="timelineContent"></div>
                    <button class="btn-primary" onclick="exportResults()" id="exportBtn" style="display: none; margin-top: 15px;">
                        ðŸ“„ Export Results
                    </button>
                </div>

                <div class="agent-cards" id="agentCards">
                    <div class="agent-card" id="classifier-card">
                        <div class="agent-header">
                            <div class="agent-name">Classifier Agent</div>
                            <div class="agent-status">Waiting...</div>
                        </div>
                        <div class="agent-content">
                            <div class="input-output">
                                <h4>Input:</h4>
                                <div class="code-block" id="classifier-input">Waiting for workflow to start...</div>
                            </div>
                            <div class="input-output">
                                <h4>Output:</h4>
                                <div class="code-block" id="classifier-output">No output yet</div>
                            </div>
                        </div>
                    </div>

                    <div class="agent-card" id="evidence-card">
                        <div class="agent-header">
                            <div class="agent-name">Evidence Agent</div>
                            <div class="agent-status">Waiting...</div>
                        </div>
                        <div class="agent-content">
                            <div class="input-output">
                                <h4>Input:</h4>
                                <div class="code-block" id="evidence-input">Waiting for classification...</div>
                            </div>
                            <div class="input-output">
                                <h4>Output:</h4>
                                <div class="code-block" id="evidence-output">No output yet</div>
                            </div>
                        </div>
                    </div>

                    <div class="agent-card" id="triage-card">
                        <div class="agent-header">
                            <div class="agent-name">Triage Agent</div>
                            <div class="agent-status">Waiting...</div>
                        </div>
                        <div class="agent-content">
                            <div class="input-output">
                                <h4>Input:</h4>
                                <div class="code-block" id="triage-input">Waiting for evidence...</div>
                            </div>
                            <div class="input-output">
                                <h4>Output:</h4>
                                <div class="code-block" id="triage-output">No output yet</div>
                            </div>
                        </div>
                    </div>

                    <div class="agent-card" id="knowledge-card">
                        <div class="agent-header">
                            <div class="agent-name">Knowledge Base Agent</div>
                            <div class="agent-status">Waiting...</div>
                        </div>
                        <div class="agent-content">
                            <div class="input-output">
                                <h4>Input:</h4>
                                <div class="code-block" id="knowledge-input">Waiting for triage...</div>
                            </div>
                            <div class="input-output">
                                <h4>Output:</h4>
                                <div class="code-block" id="knowledge-output">No output yet</div>
                            </div>
                        </div>
                    </div>

                    <div class="agent-card" id="remediation-card">
                        <div class="agent-header">
                            <div class="agent-name">Remediation Agent</div>
                            <div class="agent-status">Waiting...</div>
                        </div>
                        <div class="agent-content">
                            <div class="input-output">
                                <h4>Input:</h4>
                                <div class="code-block" id="remediation-input">Waiting for triage...</div>
                            </div>
                            <div class="input-output">
                                <h4>Output:</h4>
                                <div class="code-block" id="remediation-output">No output yet</div>
                            </div>
                        </div>
                    </div>

                    <div class="agent-card" id="summary-card">
                        <div class="agent-header">
                            <div class="agent-name">Summary Agent</div>
                            <div class="agent-status">Waiting...</div>
                        </div>
                        <div class="agent-content">
                            <div class="input-output">
                                <h4>Input:</h4>
                                <div class="code-block" id="summary-input">Waiting for remediation...</div>
                            </div>
                            <div class="input-output">
                                <h4>Output:</h4>
                                <div class="code-block" id="summary-output">No output yet</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTriageId = null;
        let startTime = null;
        let pollingInterval = null;

        // Demo scenarios
        const scenarios = {
            'payment-outage': {
                description: `Payment service is completely down since 14:30 UTC. Users are unable to complete transactions and getting 503 errors. Multiple customer complaints received via social media and support tickets. Revenue impact is significant.

Error details:
- Payment gateway returning 503 Service Unavailable
- Database connection timeouts in payment-service logs  
- CPU usage spiked to 95% on payment-db-primary
- Recent deployment of payment-service v2.1.4 at 14:25 UTC
- Load balancer health checks failing for 3/6 payment service instances

Customer impact: 
- 100% of payment transactions failing
- Estimated $50K/hour revenue loss
- 847 support tickets created in last hour`
            },
            'database-slow': {
                description: `Database performance degradation noticed since 08:00 UTC. Query response times increased from average 50ms to 2-5 seconds. Intermittent timeouts reported by multiple services.

Technical details:
- Primary database CPU at 85% consistently  
- Disk I/O wait time increased to 40%
- Slow query log showing expensive JOIN operations
- Connection pool exhaustion warnings
- No recent deployments or configuration changes

Service impact:
- checkout-service: 30% slower response times
- user-service: occasional timeout errors  
- search-service: degraded performance
- Overall user experience degraded but functional`
            },
            'auth-errors': {
                description: `Authentication service experiencing intermittent failures. Users reporting login issues and getting "Invalid credentials" errors for valid accounts.

Symptoms:
- 15% of login attempts failing with HTTP 401
- JWT token validation intermittently failing
- auth-service logs showing Redis connection errors
- Session data inconsistency reported

Infrastructure:
- Redis cluster showing node disconnection events
- Network latency spikes between auth-service and Redis
- Recent security patch applied to auth-service this morning
- Load increased 40% due to retry attempts

Impact:
- Users unable to access accounts intermittently
- Mobile app login success rate dropped to 85%
- Customer support receiving 200+ login-related tickets`
            },
            'deployment-issue': {
                description: `Issues reported after deploying inventory-service v1.8.2 at 16:45 UTC. Some product pages showing incorrect stock levels and "out of stock" errors for available items.

Deployment details:
- inventory-service v1.8.2 deployed via blue-green deployment  
- Database migration included schema changes to inventory table
- New caching layer introduced for stock level queries
- Deployment completed successfully without rollback

Issues observed:
- 5% of products showing incorrect stock levels
- Cache invalidation not working properly for stock updates
- Inventory sync job failing for some SKUs  
- Minor impact on conversion rates

Monitoring:
- No error rate increase in logs
- All health checks passing
- Performance metrics within normal ranges
- Feature flags available for rollback`
            }
        };

        // Load demo scenario
        function loadScenario(scenarioKey) {
            const scenario = scenarios[scenarioKey];
            if (scenario) {
                document.getElementById('incident').value = scenario.description;
            }
        }

        // Generate unique triage ID
        function generateTriageId() {
            const timestamp = new Date().toISOString().replace(/[-:.]/g, '').slice(0, 15);
            const random = Math.random().toString(36).substring(2, 6);
            return `TRIAGE-${timestamp}-${random}`;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Generate initial triage ID
            const triageId = generateTriageId();
            document.getElementById('triageId').value = triageId;
            
            // Load default scenario
            loadScenario('payment-outage');
        });

        // Form submission
        document.getElementById('triageForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const triageId = document.getElementById('triageId').value || generateTriageId();
            const incident = document.getElementById('incident').value;

            if (!incident.trim()) {
                alert('Please enter an incident description');
                return;
            }

            currentTriageId = triageId;
            startTime = Date.now();
            
            // Update UI for workflow start
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').innerHTML = '<div class="spinner"></div> Starting Workflow...';
            document.getElementById('metricsPanel').style.display = 'grid';

            // Reset all agent cards
            resetAgentCards();
            resetWorkflowProgress();

            try {
                // Start the triage workflow
                const response = await fetch(`/triage/${triageId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        incident: incident
                    })
                });

                if (response.ok) {
                    // Start polling for updates
                    startPolling();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

            } catch (error) {
                console.error('Error starting workflow:', error);
                showError('Failed to start workflow: ' + error.message);
                resetUI();
            }
        });

        // Reset UI state
        function resetUI() {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').innerHTML = 'ðŸš€ Start Triage Workflow';
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        // Reset agent cards
        function resetAgentCards() {
            const agents = ['classifier', 'evidence', 'triage', 'knowledge', 'remediation', 'summary'];
            agents.forEach(agent => {
                const card = document.getElementById(`${agent}-card`);
                const status = card.querySelector('.agent-status');
                card.className = 'agent-card';
                status.textContent = 'Waiting...';
                
                document.getElementById(`${agent}-input`).textContent = 'Waiting...';
                document.getElementById(`${agent}-output`).textContent = 'No output yet';
            });
        }

        // Reset workflow progress
        function resetWorkflowProgress() {
            const steps = document.querySelectorAll('.step');
            steps.forEach(step => {
                step.className = 'step';
            });
        }

        let consecutiveErrors = 0;
        let lastProgressTime = Date.now();

        // Start polling for updates
        function startPolling() {
            pollingInterval = setInterval(async () => {
                try {
                    await updateWorkflowStatus();
                    await updateDetailedState();
                    
                    // Reset error counter on success
                    consecutiveErrors = 0;
                    
                    // Check for timeout (no progress for 5 minutes)
                    if (Date.now() - lastProgressTime > 300000) {
                        showError('Workflow appears to be stuck. Consider restarting.');
                        clearInterval(pollingInterval);
                        resetUI();
                    }
                    
                } catch (error) {
                    console.error('Polling error:', error);
                    consecutiveErrors++;
                    
                    if (consecutiveErrors >= 5) {
                        showError('Multiple polling failures. Workflow may have failed.');
                        clearInterval(pollingInterval);
                        resetUI();
                    }
                }
            }, 2000); // Poll every 2 seconds
        }

        // Update workflow status
        async function updateWorkflowStatus() {
            if (!currentTriageId) return;

            try {
                const response = await fetch(`/triage/${currentTriageId}`);
                if (response.ok) {
                    const conversations = await response.json();
                    updateFromConversations(conversations);
                }
            } catch (error) {
                console.error('Error fetching conversations:', error);
            }
        }

        // Update detailed state
        async function updateDetailedState() {
            if (!currentTriageId) return;

            try {
                const response = await fetch(`/triage/${currentTriageId}/state`);
                if (response.ok) {
                    const state = await response.json();
                    updateFromState(state);
                }
            } catch (error) {
                console.error('Error fetching state:', error);
            }
        }

        // Update UI from conversations
        function updateFromConversations(conversations) {
            // Update metrics
            updateMetrics();

            let currentStep = '';
            let completedSteps = [];

            // Process conversations to understand current state and active step
            conversations.forEach((conv, index) => {
                if (conv.role === 'assistant') {
                    const content = conv.content.toLowerCase();
                    const timestamp = new Date().toLocaleTimeString();
                    
                    if (content.includes('classification completed')) {
                        completedSteps.push('classify');
                        updateStepStatus('classify', 'completed');
                        updateAgentStatus('classifier', 'completed', `Completed at ${timestamp}`);
                        if (!completedSteps.includes('evidence')) currentStep = 'evidence';
                        lastProgressTime = Date.now();
                    } else if (content.includes('evidence analysis completed')) {
                        completedSteps.push('evidence');
                        updateStepStatus('evidence', 'completed');
                        updateAgentStatus('evidence', 'completed', `Completed at ${timestamp}`);
                        if (!completedSteps.includes('triage')) currentStep = 'triage';
                        lastProgressTime = Date.now();
                    } else if (content.includes('triage analysis completed')) {
                        completedSteps.push('triage');
                        updateStepStatus('triage', 'completed');
                        updateAgentStatus('triage', 'completed', `Completed at ${timestamp}`);
                        if (!completedSteps.includes('knowledge')) currentStep = 'knowledge';
                        lastProgressTime = Date.now();
                    } else if (content.includes('knowledge base search completed.')) {
                        completedSteps.push('knowledge');
                        updateStepStatus('knowledge', 'completed');
                        updateAgentStatus('knowledge', 'completed', `Completed at ${timestamp}`);
                        if (!completedSteps.includes('remediate')) currentStep = 'remediate';
                        lastProgressTime = Date.now();
                    } else if (content.includes('remediation plan completed')) {
                        completedSteps.push('remediate');
                        updateStepStatus('remediate', 'completed');
                        updateAgentStatus('remediation', 'completed', `Completed at ${timestamp}`);
                        if (!completedSteps.includes('summarize')) currentStep = 'summarize';
                        lastProgressTime = Date.now();
                    } else if (content.includes('summaries completed')) {
                        completedSteps.push('summarize');
                        updateStepStatus('summarize', 'completed');
                        updateAgentStatus('summary', 'completed', `Completed at ${timestamp}`);
                        currentStep = 'complete';
                        lastProgressTime = Date.now();
                    } else if (content.includes('workflow completed')) {
                        updateStepStatus('complete', 'completed');
                        completeWorkflow();
                        lastProgressTime = Date.now();
                        return;
                    }
                }
            });

            // Update active step indicator
            if (currentStep && !completedSteps.includes(currentStep)) {
                updateStepStatus(currentStep, 'active');
                const agentMap = {
                    'classify': 'classifier',
                    'evidence': 'evidence', 
                    'triage': 'triage',
                    'knowledge': 'knowledge',
                    'remediate': 'remediation',
                    'summarize': 'summary'
                };
                if (agentMap[currentStep]) {
                    updateAgentStatus(agentMap[currentStep], 'active', 'Processing...');
                }
            }

            // Display conversation timeline
            updateConversationTimeline(conversations);
        }

        // Update UI from detailed state
        function updateFromState(state) {
            const incident = document.getElementById('incident').value;

            // Update classifier
            if (state.classificationJson) {
                document.getElementById('classifier-input').textContent = 
                    `Incident: ${incident.substring(0, 200)}...`;
                document.getElementById('classifier-output').textContent = 
                    formatJSON(state.classificationJson);
                updateAgentStatus('classifier', 'completed', 'Classification completed');
                
                // Extract severity for metrics
                try {
                    const classification = JSON.parse(state.classificationJson);
                    const severity = classification.classification?.severity || classification.severity || 'Unknown';
                    document.getElementById('currentSeverity').textContent = severity;
                } catch (e) {
                    // Handle non-JSON response
                    if (state.classificationJson.includes('P1')) {
                        document.getElementById('currentSeverity').textContent = 'P1';
                    } else if (state.classificationJson.includes('P2')) {
                        document.getElementById('currentSeverity').textContent = 'P2';
                    }
                }
            }

            // Update evidence
            if (state.evidenceLogs) {
                document.getElementById('evidence-input').textContent = 
                    `Service: ${extractServiceName(state.classificationJson)}\nMetrics: errors:rate5m\nTime Range: 1h`;
                document.getElementById('evidence-output').textContent = 
                    formatJSON(state.evidenceLogs);
                updateAgentStatus('evidence', 'completed', 'Evidence gathered');
            }

            // Update triage
            if (state.triageText) {
                document.getElementById('triage-input').textContent = 
                    `Incident: ${incident.substring(0, 100)}...\nClassification: ${state.classificationJson?.substring(0, 100)}...\nEvidence: ${state.evidenceLogs?.substring(0, 100)}...`;
                document.getElementById('triage-output').textContent = 
                    formatJSON(state.triageText);
                updateAgentStatus('triage', 'completed', 'Triage completed');
            }

            // Update knowledge base
            if (state.knowledgeBaseResult) {
                document.getElementById('knowledge-input').textContent = 
                    `Service: ${extractServiceName(state.classificationJson)}\nSearching runbooks and documentation...`;
                document.getElementById('knowledge-output').textContent = 
                    formatJSON(state.knowledgeBaseResult);
                updateAgentStatus('knowledge', 'completed', 'Knowledge base search completed');
            }

            // Update remediation
            if (state.remediationText) {
                document.getElementById('remediation-input').textContent = 
                    `All previous context:\n- Incident\n- Classification\n- Evidence\n- Triage Analysis\n- Knowledge Base Results`;
                document.getElementById('remediation-output').textContent = 
                    formatJSON(state.remediationText);
                updateAgentStatus('remediation', 'completed', 'Remediation planned');
            }

            // Update summary
            if (state.summaryText) {
                document.getElementById('summary-input').textContent = 
                    `Complete incident context for multi-audience summary generation`;
                document.getElementById('summary-output').textContent = 
                    formatJSON(state.summaryText);
                updateAgentStatus('summary', 'completed', 'Summary completed');
            }

            // Update status based on workflow state
            if (state.status === 'TRIAGED' && !state.knowledgeBaseResult) {
                updateAgentStatus('knowledge', 'active', 'Searching knowledge base...');
                updateStepStatus('knowledge', 'active');
            } else if (state.status === 'KNOWLEDGE_BASE_SEARCHED' && state.knowledgeBaseResult && !document.getElementById('knowledge-card').classList.contains('completed')) {
                updateAgentStatus('knowledge', 'completed', 'Knowledge base search completed');
                updateStepStatus('knowledge', 'completed');
            }

            // Check if workflow is complete
            if (state.status === 'COMPLETED') {
                completeWorkflow();
            }
        }

        // Extract service name from classification
        function extractServiceName(classificationJson) {
            if (!classificationJson) return 'unknown';
            try {
                const classification = JSON.parse(classificationJson);
                return classification.classification?.service || classification.service || 'unknown';
            } catch (e) {
                // Try regex extraction
                const match = classificationJson.match(/"service":\s*"([^"]+)"/);
                return match ? match[1] : 'unknown';
            }
        }

        // Format JSON for display
        function formatJSON(text) {
            if (!text) return 'No output yet';
            
            try {
                const parsed = JSON.parse(text);
                return JSON.stringify(parsed, null, 2);
            } catch (e) {
                // Not valid JSON, return as-is but truncated
                return text.length > 1000 ? text.substring(0, 1000) + '\n...[truncated]' : text;
            }
        }

        // Update step status
        function updateStepStatus(stepName, status) {
            const step = document.querySelector(`[data-step="${stepName}"]`);
            if (step) {
                step.className = `step ${status}`;
            }
        }

        // Update agent status
        function updateAgentStatus(agentName, status, message) {
            const card = document.getElementById(`${agentName}-card`);
            const statusEl = card.querySelector('.agent-status');
            
            card.className = `agent-card ${status}`;
            statusEl.textContent = message;
            
            if (status === 'active') {
                statusEl.innerHTML = '<div class="loading"><div class="spinner"></div>' + message + '</div>';
            }
        }

        // Update metrics
        function updateMetrics() {
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('totalTime').textContent = `${elapsed}s`;
            }

            // Count completed steps
            const completedSteps = document.querySelectorAll('.step.completed').length;
            document.getElementById('completedSteps').textContent = `${completedSteps}/7`;
        }

        // Update conversation timeline
        function updateConversationTimeline(conversations) {
            const timeline = document.getElementById('conversationTimeline');
            const timelineContent = document.getElementById('timelineContent');
            
            if (conversations && conversations.length > 0) {
                timeline.style.display = 'block';
                
                timelineContent.innerHTML = '';
                conversations.forEach(conv => {
                    const entry = document.createElement('div');
                    entry.className = `timeline-entry ${conv.role}`;
                    
                    const icon = getTimelineIcon(conv.role);
                    const roleLabel = conv.role.charAt(0).toUpperCase() + conv.role.slice(1);
                    
                    entry.innerHTML = `
                        <div class="timeline-icon">${icon}</div>
                        <div class="timeline-content">
                            <div class="timeline-role">${roleLabel}</div>
                            <div class="timeline-message">${conv.content}</div>
                            <div class="timeline-time">Step ${conversations.indexOf(conv) + 1}</div>
                        </div>
                    `;
                    
                    timelineContent.appendChild(entry);
                });
            }
        }

        // Get timeline icon based on role
        function getTimelineIcon(role) {
            switch(role) {
                case 'system': return 'âš™ï¸';
                case 'user': return 'ðŸ‘¤';
                case 'assistant': return 'ðŸ¤–';
                default: return 'ðŸ’¬';
            }
        }

        // Export results
        function exportResults() {
            if (!currentTriageId) return;

            // Gather all data for export
            const exportData = {
                triageId: currentTriageId,
                timestamp: new Date().toISOString(),
                duration: startTime ? Math.floor((Date.now() - startTime) / 1000) : 0,
                incident: document.getElementById('incident').value,
                results: {
                    classification: document.getElementById('classifier-output').textContent,
                    evidence: document.getElementById('evidence-output').textContent,
                    triage: document.getElementById('triage-output').textContent,
                    knowledgeBase: document.getElementById('knowledge-output').textContent,
                    remediation: document.getElementById('remediation-output').textContent,
                    summary: document.getElementById('summary-output').textContent
                },
                timeline: Array.from(document.querySelectorAll('.timeline-entry')).map(entry => ({
                    role: entry.querySelector('.timeline-role').textContent.toLowerCase(),
                    content: entry.querySelector('.timeline-message').textContent,
                    step: entry.querySelector('.timeline-time').textContent
                }))
            };

            // Create and download file
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `triage-${currentTriageId}-${new Date().toISOString().slice(0, 19)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showSuccess('Results exported successfully!');
        }

        // Complete workflow
        function completeWorkflow() {
            updateStepStatus('complete', 'completed');
            resetUI();
            
            // Show export button
            document.getElementById('exportBtn').style.display = 'block';
            
            // Show completion message
            setTimeout(() => {
                showSuccess('Workflow completed successfully! All agents have processed the incident.');
            }, 1000);
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            errorDiv.style.margin = '20px 0';
            
            const form = document.getElementById('triageForm');
            form.insertBefore(errorDiv, form.firstChild);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Show success message
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.margin = '20px 0';
            
            const form = document.getElementById('triageForm');
            form.insertBefore(successDiv, form.firstChild);
            
            setTimeout(() => successDiv.remove(), 8000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });
    </script>
</body>
</html>